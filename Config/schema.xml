<database name="default" defaultIdMethod="native"
          namespace="JobScooper\DataAccess"

          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          defaultPhpNamingMethod="phpname"
          xsi:noNamespaceSchemaLocation="file://code/job_scooper_v4/vendor/propel/propel/resources/xsd/database.xsd"
>

    <!--
        *************************************************

                        JobSite

        *************************************************
    -->

    <table name="job_site" phpName="JobSiteRecord" allowPkInsert="true">

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                        PRIMARY KEY
             ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  -->
        <column name="jobsite_key" phpName="JobSiteKey" type="varchar" size="100" primaryString="true"
                primaryKey="true"/>

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                        OTHER COLUMNS
             ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  -->
        <column name="plugin_class_name" phpName="PluginClassName" type="varchar" size="100"/>

        <column name="display_name" phpName="DisplayName" type="varchar" size="255"/>

        <column name="is_disabled" phpName="isDisabled" type="boolean" defaultValue="false"/>

        <!--<column name="date_last_pulled" phpName="LastPulledAt" type="timestamp" skipSql="true" lazyLoad="true"/>-->
        <!--<behavior name="aggregate_column" id="date_last_pulled">-->
        <!--<parameter name="name" value="date_last_pulled"/>-->
        <!--<parameter name="foreign_table" value="user_search_jobsite_run"/>-->
        <!--<parameter name="expression" value="MAX(date_ended)"/>-->
        <!--<parameter name="condition" value="run_result_code = 4"/>-->
        <!--</behavior>-->


        <!--<column name="date_last_run" phpName="LastRunAt" type="timestamp" skipSql="true" lazyLoad="true"/>-->
        <!--<behavior name="aggregate_column" id="date_last_run">-->
        <!--<parameter name="name" value="date_last_run"/>-->
        <!--<parameter name="foreign_table" value="user_search_jobsite_run"/>-->
        <!--<parameter name="expression" value="MAX(date_started)"/>-->
        <!--</behavior>-->

        <!--<column name="date_last_completed" phpName="LastCompletedAt" type="timestamp" lazyLoad="true" skipSql="true"/>-->
        <!--<behavior name="aggregate_column" id="date_last_completed">-->
        <!--<parameter name="name" value="date_last_completed"/>-->
        <!--<parameter name="foreign_table" value="user_search_jobsite_run"/>-->
        <!--<parameter name="expression" value="MAX(date_ended)"/>-->
        <!--<parameter name="condition" value="run_result_code = 4"/>-->
        <!--</behavior>-->

        <!--<column name="date_last_failed" phpName="LastFailedAt" type="timestamp"/>-->
        <!--<behavior name="aggregate_column" id="date_last_failed">-->
        <!--<parameter name="name" value="date_last_failed"/>-->
        <!--<parameter name="foreign_table" value="user_search_jobsite_run"/>-->
        <!--<parameter name="expression" value="MAX(date_ended)"/>-->
        <!--<parameter name="condition" value="run_result_code = 1"/>-->
        <!--</behavior>-->

        <!--<column name="last_user_search_jobsite_run_id" phpName="LastUserSearchRunId" type="integer" lazyLoad="true"-->
        <!--skipSql="true"/>-->
        <!--<foreign-key foreignTable="user_search_jobsite_run">-->
        <!--<reference local="last_user_search_jobsite_run_id" foreign="user_search_jobsite_run_id"/>-->
        <!--</foreign-key>-->
        <!--<behavior name="aggregate_column">-->
        <!--<parameter name="name" value="last_user_search_jobsite_run_id"/>-->
        <!--<parameter name="foreign_table" value="user_search_jobsite_run"/>-->
        <!--<parameter name="expression" value="MAX(user_search_jobsite_run_id)"/>-->
        <!--</behavior>-->
        <!--
                <foreign-key foreignTable="user_search_jobsite_run" >
                    <reference local="last_user_search_jobsite_run_id" foreign="user_search_jobsite_run_id"/>
                </foreign-key>
        -->
        <column name="results_filter_type" phpName="ResultsFilterType" type="enum"
                valueSet="unknown, all-only, all-by-location, user-filtered" defaultValue="unknown"/>
    </table>


    <!--
        *************************************************

                        GeoLocation

        *************************************************
    -->


    <table name="geolocation" phpName="GeoLocation" allowPkInsert="true">
        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                        PRIMARY KEY
             ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  -->
        <column name="geolocation_id" phpName="GeoLocationId" type="integer" required="true" primaryKey="true"
                autoIncrement="true"/>

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                        OTHER COLUMNS
             ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  -->

        <column name="display_name" phpName="DisplayName" type="varchar" size="100" required="true"
                primaryString="true"/>

        <column name="geolocation_key" phpName="GeoLocationKey" type="varchar" size="100" required="true"/>

        <column name="place" phpName="Place" type="varchar" size="100"/>
        <column name="county" phpName="County" type="varchar" size="100"/>
        <column name="region" phpName="Region" type="varchar" size="100"/>
        <column name="regioncode" phpName="RegionCode" type="varchar" size="50"/>
        <column name="country" phpName="Country" type="varchar" size="100"/>
        <column name="countrycode" phpName="CountryCode" type="varchar" size="5"/>

        <column name="latitude" phpName="Latitude" type="float"/>
        <column name="longitude" phpName="Longitude" type="float"/>
        <behavior name="geocodable">
            <parameter name="auto_update" value="false"/>
            <parameter name="latitude_column" value="latitude"/>
            <parameter name="longitude_column" value="longitude"/>
            <parameter name="type" value="DOUBLE"/>
            <parameter name="size" value="11"/>
            <parameter name="scale" value="8"/>
        </behavior>

        <column name="alternate_names" phpName="AlternateNames" type="array"/>

    </table>

    <!--
        *************************************************

                            JobPosting

        *************************************************
    -->


    <table name="jobposting" phpName="JobPosting" allowPkInsert="true">

        <!-- ~~~~~~~~~  PRIMARY KEY  ~~~~~~~~~~~~~~~~~~  -->
        <column name="jobposting_id" phpName="JobPostingId" type="integer" required="true" primaryKey="true"
                autoIncrement="true"/>

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                        OTHER COLUMNS
             ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  -->
        <!--
            Alternate unique key for every job post is jobsite_key + jobsite post id
        -->
        <column name="jobsite_key" phpName="JobSiteKey" type="varchar" size="100" required="true"/>
        <foreign-key foreignTable="job_site" phpName="JobSiteFromJP">
            <reference local="jobsite_key" foreign="jobsite_key"/>
        </foreign-key>


        <column name="jobsite_post_id" phpName="JobSitePostId" type="varchar" size="1024" required="true"/>

        <!--
            Job posting facts
        -->
        <column name="title" phpName="Title" type="varchar" size="255" required="true"/>
        <column name="title_tokens" phpName="TitleTokens" type="varchar" size="255"/>
        <column name="url" phpName="Url" type="varchar" size="2500" required="true"/>
        <column name="employment_type" phpName="EmploymentType" type="varchar" size="100"/>
        <column name="pay_range" phpName="PayRange" type="varchar" size="100"/>
        <column name="company" phpName="Company" type="varchar" size="100"/>
        <column name="location" phpName="Location" type="varchar" size="255"/>
        <column name="department" phpName="Department" type="varchar" size="255"/>
        <column name="category" phpName="Category" type="varchar" size="100"/>

        <!--
            Date & times for various events related to this particular job posting
        -->
        <column name="last_updated_at" phpName="UpdatedAt" type="timestamp" required="true"/>
        <column name="job_posted_date" phpName="PostedAt" type="timestamp"/>
        <column name="first_seen_at" phpName="FirstSeenAt" type="timestamp" required="true"/>
        <column name="post_removed_at" phpName="RemovedAt" type="timestamp"/>
        <behavior name="timestampable">
            <parameter name="create_column" value="first_seen_at"/>
            <parameter name="update_column" value="last_updated_at"/>
        </behavior>

        <!--
            GeoLocation Data for the Job Posting
        -->
        <column name="location_display_value" phpName="LocationDisplayValue" type="varchar" size="255"
        />
        <column name="geolocation_id" phpName="GeoLocationId" type="integer"/>
        <foreign-key foreignTable="geolocation" phpName="GeoLocationFromJP">
            <reference local="geolocation_id" foreign="geolocation_id"/>
        </foreign-key>

        <column name="duplicates_posting_id" phpName="DuplicatesJobPostingId" type="integer"/>
        <foreign-key foreignTable="jobposting" phpName="DuplicateJobPosting">
            <reference local="duplicates_posting_id" foreign="jobposting_id"/>
        </foreign-key>

        <!--
            The following columns are automatically set via code in the JobPosting class
        -->
        <column name="key_company_and_title" phpName="KeyCompanyAndTitle" type="varchar" size="255" required="true"/>

    </table>

    <!--
        *************************************************

                            User

        *************************************************
    -->


    <table name="user" phpName="User" allowPkInsert="true">
        <!-- ~~~~~~~~~  PRIMARY KEY  ~~~~~~~~~~~~~~~~~~  -->
        <column name="user_id" phpName="UserId" type="integer" required="true" autoIncrement="true"
                primaryKey="true"/>

        <!-- ~~~~~~~~~  OTHER COLUMNS  ~~~~~~~~~~~~~~~~  -->
        <column name="user_slug" phpName="UserSlug" type="varchar" size="128" required="true" primaryString="true"/>
        <behavior name="sluggable">
            <parameter name="slug_column" value="user_slug"/>
            <parameter name="slug_pattern" value="{EmailAddress}"/>
            <parameter name="replace_pattern" value="/[^\w\/]+/u"/>
            <parameter name="replacement" value=""/>
            <parameter name="separator" value="-"/>
            <parameter name="permanent" value="false"/>
        </behavior>

        <column name="email_address" phpName="EmailAddress" type="varchar" size="128" required="true"/>
        <unique>
            <unique-column name="email_address"/>
        </unique>
        <column name="name" phpName="Name" type="varchar" size="128" required="true" defaultValue="email_address"/>
    </table>

    <!--
        *************************************************

                  User Keyword Set

        *************************************************
    -->


    <table name="user_keyword_set" phpName="UserKeywordSet" allowPkInsert="true" isCrossRef="true">


        <!-- ~~~~~~~~~  PRIMARY KEY  ~~~~~~~~~~~~~~~~~~  -->
        <column name="user_id" phpName="UserId" type="integer" required="true" primaryKey="true"/>
        <foreign-key foreignTable="user" onDelete="cascade" phpName="UserFromUKS" onUpdate="cascade">
            <reference local="user_id" foreign="user_id"/>
        </foreign-key>

        <column name="user_keyword_set_key" phpName="UserKeywordSetKey" type="varchar" size="100" required="true"
                primaryKey="true"/>
        <behavior name="sluggable">
            <parameter name="slug_column" value="user_keyword_set_key"/>
            <parameter name="slug_pattern" value="user{UserId}_search{SearchKeyFromConfig}"/>
            <parameter name="replace_pattern" value="/[^\w\/]+/u"/>
            <parameter name="replacement" value=""/>
            <parameter name="separator" value="_"/>
            <parameter name="permanent" value="true"/>
        </behavior>

        <!-- ~~~~~~~~~  OTHER COLUMNS  ~~~~~~~~~~~~~~~~  -->
        <column name="search_key_from_config" phpName="SearchKeyFromConfig" type="varchar" size="50" required="true"/>

        <column name="keywords" phpName="Keywords" type="array" required="true"/>

        <column name="keyword_tokens" phpName="KeywordTokens" type="array"/>

    </table>

    <!--
        *************************************************

                  User Search

        *************************************************
    -->


    <table name="user_search" phpName="UserSearch" isCrossRef="true" reloadOnUpdate="true">

        <!-- ~~~~~~~~~  PRIMARY KEY  ~~~~~~~~~~~~~~~~~~  -->
        <column name="user_id" phpName="UserId" type="integer" required="true" primaryKey="true"/>

        <column name="user_keyword_set_key" phpName="UserKeywordSetKey" type="varchar" size="100" required="true"
                primaryKey="true"/>

        <column name="geolocation_id" phpName="GeoLocationId" type="integer" required="true" primaryKey="true"/>

        <!-- ~~~~~~~~~  OTHER COLUMNS  ~~~~~~~~~~~~~~~~  -->

        <column name="user_search_key" phpName="UserSearchKey" type="varchar" size="100" required="true"
                primaryString="true"/>
        <behavior name="sluggable">
            <parameter name="slug_column" value="user_search_key"/>
            <parameter name="slug_pattern" value="{UserKeywordSetKey}_geo{GeoLocationId}"/>
            <parameter name="replace_pattern" value="/[^\w\/]+/u"/>
            <parameter name="replacement" value=""/>
            <parameter name="separator" value="-"/>
            <parameter name="permanent" value="true"/>
        </behavior>

        <column name="date_created" phpName="CreatedAt" type="timestamp"/>
        <column name="date_updated" phpName="UpdatedAt" type="timestamp"/>
        <behavior name="timestampable">
            <parameter name="create_column" value="date_created"/>
            <parameter name="update_column" value="date_updated"/>
        </behavior>

        <!-- ~~~~~~~~~  FOREIGN KEYS ~~~~~~~~~~~~~~~~  -->

        <foreign-key foreignTable="user" onDelete="cascade" phpName="UserFromUS" skipSql="true" onUpdate="cascade">
            <reference local="user_id" foreign="user_id"/>
        </foreign-key>

        <foreign-key foreignTable="user_keyword_set" phpName="UserKeywordSetFromUS" onUpdate="cascade" skipSql="true">
            <reference local="user_keyword_set_key" foreign="user_keyword_set_key"/>
            <reference local="user_id" foreign="user_id"/>
        </foreign-key>

        <foreign-key foreignTable="geolocation" phpName="GeoLocationFromUS" skipSql="true">
            <reference local="geolocation_id" foreign="geolocation_id"/>
        </foreign-key>

        <!--<column name="date_last_run" phpName="LastRunAt" type="timestamp"/>-->
        <!--<behavior name="aggregate_column" id="us_date_last_run">-->
        <!--<parameter name="name" value="date_last_run" />-->
        <!--<parameter name="foreign_table" value="user_search_jobsite_run" />-->
        <!--<parameter name="expression" value="MAX(date_started)" />-->
        <!--</behavior>-->

        <!--<column name="date_last_completed" phpName="LastCompletedAt" type="timestamp"/>-->
        <!--<behavior name="aggregate_column" id="us_date_last_completed">-->
        <!--<parameter name="name" value="date_last_completed"/>-->
        <!--<parameter name="foreign_table" value="user_search_jobsite_run"/>-->
        <!--<parameter name="expression" value="MAX(date_ended)"/>-->
        <!--<parameter name="condition" value="run_result_code = 4"/>-->
        <!--</behavior>-->

        <!--<column name="date_last_failed" phpName="LastFailedAt" type="timestamp"/>-->
        <!--<behavior name="aggregate_column" id="us_date_last_failed">-->
        <!--<parameter name="name" value="date_last_failed" />-->
        <!--<parameter name="foreign_table" value="user_search_jobsite_run" />-->
        <!--<parameter name="expression" value="MAX(date_ended)" />-->
        <!--<parameter name="condition" value="run_result_code = failed" />-->
        <!--</behavior>-->

    </table>

    <!--
        *************************************************

                  User Search JobSite Run

        *************************************************
    -->


    <table name="user_search_site_run" phpName="UserSearchSiteRun" isCrossRef="true" reloadOnUpdate="true">

        <!--  Primary Key -->
        <column name="user_id" phpName="UserId" type="integer" required="true"/>

        <column name="user_keyword_set_key" phpName="UserKeywordSetKey" type="varchar" size="100" required="true"
                primaryKey="true"/>

        <column name="geolocation_id" phpName="GeoLocationId" type="integer" required="true" primaryKey="true"/>

        <column name="jobsite_key" phpName="JobSiteKey" type="varchar" size="100" required="true" primaryKey="true"/>

        <column name="app_run_id" phpName="AppRunId" type="varchar" size="75" required="true" primaryKey="true"/>

        <!-- ~~~~~~~~~  OTHER COLUMNS  ~~~~~~~~~~~~~~~~  -->
        <column name="user_search_key" phpName="UserSearchKey" type="varchar" size="100" required="true"/>

        <!--<foreign-key foreignTable="user_keyword_set" onDelete="cascade" phpName="UserKeywordSetFromUSSR">-->
        <!--<reference local="user_id" foreign="user_id"/>-->
        <!--<reference local="user_keyword_set_id" foreign="user_keyword_set_id"/>-->
        <!--</foreign-key>-->

        <!--<unique>-->
        <!--<unique-column name="user_id"/>-->
        <!--<unique-column name="geolocation_id"/>-->
        <!--<unique-column name="user_keyword_set_key"/>-->
        <!--<unique-column name="jobsite_key" size="20"/>-->
        <!--<unique-column name="app_run_id" size="15"/>-->
        <!--</unique>-->

        <!--<column name="user_search_site_run_id" phpName="UserSearchSiteRunId" type="integer" required="true"-->
                <!--autoIncrement="true"/>-->
        <!--<unique>-->
            <!--<unique-column name="user_search_site_run_id"/>-->
        <!--</unique>-->

        <column name="user_search_site_run_key" phpName="UserSearchSiteRunKey" type="varchar" size="100" required="true"
                primaryString="true"/>
        <behavior name="sluggable">
            <parameter name="slug_column" value="user_search_site_run_key"/>
            <parameter name="slug_pattern" value="search{UserSearchKey}_{JobSiteKey}_{AppRunId}"/>
            <parameter name="replace_pattern" value="/[^\w\/]+/u"/>
            <parameter name="replacement" value=""/>
            <parameter name="separator" value="-"/>
            <parameter name="permanent" value="true"/>
        </behavior>

        <column name="search_start_url" phpName="SearchStartUrl" type="varchar" size="1024"/>

        <column name="run_result_code" phpName="RunResultCode" type="enum"
                valueSet="not-run,failed,excluded,skipped,successful" defaultValue="not-run"/>

        <column name="run_error_details" phpName="RunErrorDetails" type="array"/>


        <column name="date_started" phpName="StartedAt" type="timestamp"/>
        <column name="date_ended" phpName="EndedAt" type="timestamp"/>

        <!-- ~~~~~~~~~  FOREIGN KEYS ~~~~~~~~~~~~~~~~  -->

        <foreign-key foreignTable="job_site" onDelete="cascade" phpName="JobSiteFromUSSR">
            <reference local="jobsite_key" foreign="jobsite_key"/>
        </foreign-key>

        <foreign-key foreignTable="user_search" onDelete="cascade" onUpdate="cascade" phpName="UserSearchFromUSSR">
            <reference local="user_id" foreign="user_id"/>
            <reference local="user_keyword_set_key" foreign="user_keyword_set_key"/>
            <reference local="geolocation_id" foreign="geolocation_id"/>
            <reference local="user_search_key" foreign="user_search_key"/>
        </foreign-key>

        <!-- Model-only relationship -->
        <foreign-key foreignTable="user" onDelete="cascade" skipSql="true" phpName="UserFromUSSR">
            <reference local="user_id" foreign="user_id"/>
        </foreign-key>


        <!-- Model-only relationship -->
        <foreign-key foreignTable="geolocation" onDelete="cascade" onUpdate="cascade" skipSql="true" phpName="GeoLocationFromUSSR">
            <reference local="geolocation_id" foreign="geolocation_id"/>
        </foreign-key>


    </table>

    <!--
        *************************************************

                  User Job Match

        *************************************************
    -->


    <table name="user_job_match" phpName="UserJobMatch" isCrossRef="true">
        <column name="user_id" phpName="UserId" type="integer" required="true" primaryKey="true"/>
        <foreign-key foreignTable="user" onDelete="cascade" phpName="UserFromUJM">
            <reference local="user_id" foreign="user_id"/>
        </foreign-key>

        <column name="jobposting_id" phpName="JobPostingId" type="integer" required="true" primaryKey="true"/>
        <foreign-key foreignTable="jobposting" onDelete="cascade" phpName="JobPostingFromUJM">
            <reference local="jobposting_id" foreign="jobposting_id"/>
        </foreign-key>

        <column name="user_job_match_id" phpName="UserJobMatchId" type="integer" required="true"
                autoIncrement="true"/>
        <unique>
            <unique-column name="user_job_match_id"/>
        </unique>

        <column name="user_notification_state" phpName="UserNotificationState" type="enum"
                valueSet="not-ready,ready,sent" defaultValue="not-ready"/>
        <column name="is_job_match" phpName="IsJobMatch" type="boolean"/>
        <column name="is_excluded" phpName="IsExcluded" type="boolean"/>
        <column name="is_include_in_notifications" phpName="IsIncludeInNotifications" type="boolean"/>
        <column name="matched_user_keywords" phpName="MatchedUserKeywords" type="array"/>
        <column name="matched_negative_title_keywords" phpName="MatchedNegativeTitleKeywords" type="array"/>
        <column name="matched_negative_company_keywords" phpName="MatchedNegativeCompanyKeywords" type="array"/>
        <column name="out_of_user_area" phpName="OutOfUserArea" type="boolean"/>
        <column name="app_run_id" phpName="AppRunId" type="varchar" size="75"/>
    </table>

</database>
